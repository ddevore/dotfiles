if &shell=~# 'fish$'
  set shell=/bin/sh
endif

" --- bundles {{
call plug#begin('~/.nvim/plugged')                         " https://github.com/junegunn/vim-plug

Plug 'https://github.com/tpope/vim-fugitive'               " git:   wrapper for commands
Plug 'https://github.com/airblade/vim-gitgutter'           " git:   diff in gutter

Plug 'https://github.com/reedes/vim-colors-pencil'         " theme: for markdown and more
Plug 'https://github.com/altercation/vim-colors-solarized' " theme: solarized
Plug 'https://github.com/chriskempson/base16-vim'          " theme: base-16

Plug 'https://github.com/itspriddle/vim-marked'            " nav:   marked for markdown preview
Plug 'https://github.com/scrooloose/nerdtree'              " nav:   explorer style navigation
Plug 'https://github.com/Xuyuanp/nerdtree-git-plugin'      " nav:   git support for nerdtree
Plug 'https://github.com/tpope/vim-vinegar'

Plug 'https://github.com/rking/ag.vim'                     " util:  'silver_searcher' replacement for ack
Plug 'https://github.com/godlygeek/tabular'                " util:  filtering and alignment
Plug 'https://github.com/tpope/vim-surround'               " util:  surrounds with brackets, quotes, etc.
Plug 'https://github.com/tyru/caw.vim'                     " Util:  comment out code
Plug 'https://github.com/terryma/vim-multiple-cursors'     " util:  multiple cursor support like sublime
Plug 'https://github.com/ervandew/supertab'                " util:  tab completion
Plug 'https://github.com/rizzatti/dash.vim'                " util:  load dash

Plug 'https://github.com/gabrielelana/vim-markdown'        " lang:  markdown support (must come after tabular)
Plug 'https://github.com/derekwyatt/vim-scala'             " lang:  scala syntax support and more
Plug 'https://github.com/ironfish/scala-api-complete'      " lang:  my autocomplete for scala

Plug 'https://github.com/bling/vim-airline'                " ui:    mean status / tabline for vim
Plug 'https://github.com/Yggdroot/indentLine'              " ui:    indents as thin vertical lines
Plug 'junegunn/fzf', { 'dir': '~/.fzf', 'do': 'yes \| ./install' }

call plug#end()
" --- bundles }}

" --- behaviors {{
filetype plugin indent on
filetype plugin on
set autoindent                                             " copy indent to new line
set autoread                                               " when a file has changed outside of nvim
set backspace=indent,eol,start                             " backspace over autoindent, eol, start to join lines
set clipboard=unnamed                                      " use system clipboard
set colorcolumn=+1                                         " set the right margin
set cursorcolumn                                           " highlight the current column
set cursorline                                             " highlight the current line
set encoding=utf-8                                         " default set by neovim
set expandtab                                              " replace tabs with spaces
set history=100                                            " remember some stuff
set laststatus=2                                           " set status line position
set lazyredraw                                             " redraw only when needed
set linebreak                                              " wrap at word
set matchpairs=(:),[:],{:},<:>                             " highlight matching tags
set mouse=a                                                " mouse support
set number                                                 " show line numbers
set ruler                                                  " show ruler in status line
set scrolloff=8                                            " keep cursor 8 lines from top and bottom when page scrolls
set shortmess+=A                                           " don't warn when there is an existing swap file
set shiftwidth=2                                           " number of spaces to use for indent
set showbreak=↪                                            " show break character when wrapping
set showcmd                                                " show information about current command
set showfulltag                                            " show the whole tag, not just the function name
set showmode                                               " show mode in status line
set softtabstop=2                                          " use 2 spaces, interpret tab as indent
set t_vb=                                                  " clear the stupid flashing
set tabstop=2                                              " set tab width
set textwidth=132                                          " set width to 132
set timeoutlen=300                                         " wait 300 millis for mapped key
set title                                                  " set the current file name to the title
if !has('nvim')
set ttyfast                                                " fast terminal
endif
set visualbell                                             " turn of the stup bell.
set whichwrap=h,l,[<]>],[<\>]                              " Make cursor keys wrap (] and \ are for right and left arrows).
set wildmenu                                               " set menu for tab key
set wildmode=list:longest,full                             " complete only up to the point of ambiguity

" directories
set backupdir=~/dotfiles/tmp/nvim-backup/                  " backup directory
set directory=~/dotfiles/tmp/nvim-swap/                    " swap file directory
set undodir=~/dotfiles/tmp/nvim-undo/                      " undo directory
set viewdir=~/dotfiles/tmp/nvim-view/                      " view directory
set viminfo='1000,n~/dotfiles/tmp/viminfo                  " viminfo directory

" list of invisible character to show
set list listchars=tab:»-,trail:·,nbsp:·,extends:»,precedes:«,eol:¬
" --- behaviors }}

" --- folding {{
" don't fold files by default on open
set nofoldenable
" fold marker
set foldmarker={{,}}
" fold based on indent level
set foldmethod=marker
set foldlevel=1
set foldlevelstart=10
set foldnestmax=10
" --- folding }}

" --- mappings {{
" remap leader to ,
let mapleader=","
" ,f to fold
nnoremap <leader>f za
" ctrl-r for redo sucks, use uppercase U instead
noremap U <C-R>

" ,s to save
noremap  <leader>s :update<CR>
vnoremap <leader>s <C-C>:update<CR>
inoremap <leader>s <C-O>:update<CR>

" ,e to go to end of line
imap     <leader>e <esc>$
nnoremap <leader>e $
vnoremap <leader>e $

" ,b to go to beginning of line
imap     <leader>b <esc>0
nnoremap <leader>b 0
vnoremap <leader>b 0

" use tab instead of % to switch between matching pair
nnoremap <tab> %
vnoremap <tab> %

" toggle number/relativenumber
nnoremap <leader>n :call ToggleNumber()<CR>
" toggle/clear highlights
nnoremap <leader>h :noh<cr>
" toggle invisible characters
nnoremap <leader>i :set list!<CR>
" close buffer
nnoremap <leader>d :bd<CR>
" vertical window split
nnoremap <leader>v <C-w>v
" move to left split
nnoremap <leader><leader>l <C-w><left>
" move to right split
nnoremap <leader><leader>r <C-w><right>
" horizontal window split
nnoremap <leader><leader>h <C-w>s
" move to down split
nnoremap <leader><leader>d <C-w><down>
" move to up split
nnoremap <leader><leader>u <C-w><up>
" move cursor down within non-breaking lines
nnoremap j gj
" move cursor up within non-breaking lines
nnoremap k gk
" --- mappings }}

" --- search {{
" highlight search results
set hlsearch
" set search to ignore case
set ignorecase
" incremental highlight as search is typed
set incsearch
" case sensitive search when given caps
set smartcase
" set search to wrap lines
set wrapscan
" --- search }}

" --- spelling {{
" turn on tab completion for spelling
set complete+=kspell
" unix/osx dictionary
set dictionary+=/usr/share/dict/words
" spelling whitelist
set spellfile=$HOME/.nvim/spell/en.utf8.add
" spelling language
set spelllang=en_us
" toggle spelling
map <leader>ss :setlocal spell!<cr>
" --- spelling }}

" --- file configs {{
" html
autocmd FileType html setlocal shiftwidth=4
autocmd FileType html setlocal tabstop=4
autocmd FileType html setlocal softtabstop=4
autocmd FileType html setlocal expandtab
" markdown
autocmd FileType md   setlocal textwidth=0
" python
autocmd FileType python setlocal shiftwidth=4
autocmd FileType python setlocal tabstop=4
autocmd FileType python setlocal softtabstop=4
autocmd FileType python setlocal expandtab
" scala
autocmd BufNewFile,BufRead *.scala set filetype=scala
autocmd FileType scala setlocal shiftwidth=2
autocmd FileType scala setlocal tabstop=2
autocmd FileType scala setlocal softtabstop=2
autocmd FileType scala setlocal expandtab
autocmd FileType scala setlocal foldmethod=indent
autocmd FileType scala setlocal foldlevel=1
autocmd FileType scala setlocal foldlevelstart=10
autocmd FileType scala setlocal foldnestmax=10
autocmd FileType scala setlocal nofoldenable
autocmd FileType scala setlocal omnifunc=scalaapi#complete
" --- file configs }}

" --- colorsheme {{
" important for dark color schemes
set background=dark
" note: this must come first before settings
colorscheme solarized
" important for terminal (non-gui)
let g:solarized_termcolors = 256
let g:solarized_underline  = 0
let g:solarized_contrast   = "high"
" Sign Column made by solarized color is strange, clear it
highlight clear SignColumn
" set airblade's theme to solorized
let g:airline_theme        = 'solarized'
" --- colorscheme }}

" --- airline {{
let g:airline_powerline_fonts = 1

if !exists('g:airline_symbols')
  let g:airline_symbols = {}
endif
let g:airline_symbols.space = "\ua0"
let g:airline#extensions#tabline#enabled = 1
" -- airline }}

" --- caw commenter {{
nmap <Leader>c <Plug>(caw:I:toggle)
vmap <Leader>c <Plug>(caw:I:toggle)
" --- caw commentor }}

" --- gitgutter {{
" disable gutter when gitgutter disabled
let g:gitgutter_sign_column_always=0
" enable at start
let g:gitgutter_enabled = 1
" enable signs
let g:gitgutter_signs = 1
" enable line highlights
let g:gitgutter_highlight_lines=0
" gitgutter will use Sign Column to set its color, reload it
call gitgutter#highlight#define_highlights()
" toggle gitgutter
nnoremap <leader>gg :GitGutterToggle<CR>
" --- gitgutter }}

" --- fzf {{
" --- Search like ctrlp
" source:  use ag with (l=files-with-matches, g=PATTERN)
" sink:    vim edit
" options: fzf multi-select
nnoremap <space><space> :call fzf#run({
\  'source':  'ag -l -g ""',
\  'sink':    'e',
\  'options': '-m',
\  'down':    '40%'
\ })<CR>

" open in a new tab
nnoremap <space>t :call fzf#run({
\  'source':  'ag -l -g ""',
\  'sink':    'tabe',
\  'options': '-m',
\  'down':    '40%'
\ })<CR>

" horizontal split
nnoremap <silent> <space>h :call fzf#run({
\  'source':  'ag -l -g ""',
\  'down':    '40%',
\  'sink':    'botright split' })<CR>

" vertical split
nnoremap <silent> <space>v :call fzf#run({
\  'source':  'ag -l -g ""',
\  'right':   winwidth('.') / 2,
\  'sink':    'vertical botright split' })<CR>

" --- Buffer select
function! s:buflist()
  redir => ls
  silent ls
  redir END
  return split(ls, '\n')
endfunction

function! s:bufopen(e)
  execute 'buffer' matchstr(a:e, '^[ 0-9]*')
endfunction

nnoremap <silent> <space>b :call fzf#run({
\  'source':      reverse(<sid>buflist()),
\  'sink':        function('<sid>bufopen'),
\  'options':     '+m',
\  'down':        len(<sid>buflist()) + 2 })<CR>
" --- fzf }}

" --- indentLine {{
let g:indentLine_char='┆'
let g:indentLine_leadingSpaceChar="."
let g:indentLine_leadingSpaceEnabled=1
" --- indentline }}

" --- nerdtree {{
" make nerdtree act like netrw
let NERDTreeHijackNetrw=1
" toggle nerdtree
nnoremap <leader>t :NERDTreeToggle<CR>
" set bookmarks file
let NERDTreeBookmarksFile=expand("$HOME/dotfiles/tmp/ntbookmarks")
" show bookmarks table
let NERDTreeShowBookmarks=1
" show hidden files
let NERDTreeShowHidden=1
" -- nerdtree }}

" --- supertab {{
"@see - https://github.com/ervandew/supertab/issues/99
let g:SuperTabDefaultCompletionType = "context"
let g:SuperTabContextDefaultCompletionType = "<c-p>"
let g:SuperTabCompletionContexts = ['s:ContextText', 's:ContextDiscover']
let g:SuperTabContextDiscoverDiscovery = ["&omnifunc:<c-x><c-o>"]
autocmd FileType *
  \ if &omnifunc != '' |
  \ call SuperTabChain(&omnifunc, "<c-p>") |
  \ call SuperTabSetDefaultCompletionType("<c-x><c-u>") |
  \ endif
" --- supertab }}

" --- functions {{
function! ToggleNumber()
  if(&relativenumber == 1)
    set norelativenumber
    set number
  else
    set relativenumber
  endif
endfunction
" --- functions }}
